<!-- 222356f7-ad5f-4cf0-a3dc-942ce5992dfa eab18ab6-09bb-4335-aa28-22b808ea7054 -->
# Chat History + Swarm UI + Select Guard – Minimal Implementation Plan

### Scope

Implement three focused fixes:

- Fix invalid session type in chat init (general vs user_chat)
- Deduplicate Admin Swarms tabs and stabilize keys
- Add safeSelect() guard and apply only to chat/session selects

### A) Fix chat session initialization

- File: `src/utils/chatManager.ts`
- Change `'user_chat'` → `'general'` in `ensureActiveSession`:
- Before: `ChatSessions.getOrCreateActiveSession(userId, 'user_chat')`
- After: `ChatSessions.getOrCreateActiveSession(userId, 'general')`
- Repo audit: grep `user_chat` and replace only if used as a session type argument elsewhere.

Acceptance:

- No 400s on chat init
- Same `session_id` across two messages
- Refresh restores prior messages

### B) Deduplicate tabs + stable keys in Admin Swarms

- File: `src/pages/admin/SwarmsPage.tsx`
- In the `tabs` `useMemo`, introduce `usedIds = new Set(['personality'])` and skip duplicates.
- Generate each legacy tab id as `swarm-${s.id ?? s.name.toLowerCase()}` and only include if not already in `usedIds`.
- Render tabs using `key={tab.id}` (not a formatted template key).

Acceptance:

- No duplicate key warnings
- Tabs render and switch reliably

### C) Guard against malformed select patterns

- New File: `src/lib/safeSelect.ts`
- `safeSelect(columns: string)` validates:
- Non-empty string
- Rejects `:[0-9]+`
- Allows only `[a-zA-Z0-9_.*,()!>\-\s]`
- File: `src/core/chat/sessions.ts`
- Wrap select strings:
- `.select(safeSelect('id, started_at'))`
- `.select(safeSelect('id'))`
- Add console instrumentation on guard failures to log the offending columns string.

Acceptance:

- No `?select=id:1` in network
- Invalid select attempts throw early with clear message

### D) RLS validation (read-only check)

- Confirm RLS policies already allow user to SELECT/INSERT own `chat_sessions` and `chat_messages`.
- No schema changes; report only if blocked.

### Verification steps

- Dev server: start, hard refresh
- Chat page: init → send two messages → refresh
- Network tab: confirm selects look correct; no 400s
- Admin Swarms: open and switch tabs; confirm no React warnings

### Stretch (optional, time-permitting)

- Add toast on session-creation failure: “Couldn’t create a chat session. Please try again.” (use existing toast)

### To-dos

- [ ] Change chat session type to 'general' in `src/utils/chatManager.ts`
- [ ] Grep repo for 'user_chat' and fix session type usages
- [ ] Deduplicate tabs and use key=tab.id in `src/pages/admin/SwarmsPage.tsx`
- [ ] Create `src/lib/safeSelect.ts` with validation logic
- [ ] Wrap select calls in `src/core/chat/sessions.ts` with safeSelect
- [ ] Add console.warn/error when safeSelect rejects columns
- [ ] Manual verify: no 400s, session persists, refresh restores
- [ ] Manual verify: no duplicate key warnings; tabs stable