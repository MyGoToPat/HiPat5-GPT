# Implementation Architecture Diagram

## Phase 3: UI Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AppBar                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Back Button  â”‚  â”‚ InboxBell    â”‚  â”‚ Menu Button  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚ (click)                          â”‚
â”‚                           â–¼                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚ InboxModal   â”‚                          â”‚
â”‚                    â”‚ â€¢ Announcements â”‚                       â”‚
â”‚                    â”‚ â€¢ Read/Unread â”‚                         â”‚
â”‚                    â”‚ â€¢ Mark as Readâ”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Database        â”‚
                    â”‚  â€¢ announcements   â”‚
                    â”‚  â€¢ announcement_   â”‚
                    â”‚    reads           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase 5: USDA Macro Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TMWYA Pipeline                               â”‚
â”‚                                                               â”‚
â”‚  User Input â†’ Parse â†’ Resolve â†’ Validate â†’ Verify â†’ Log      â”‚
â”‚                  â”‚        â”‚         â”‚          â”‚               â”‚
â”‚                  â–¼        â–¼         â–¼          â–¼               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚              â”‚NLU â”‚  â”‚ Food   â”‚ â”‚ Macro    â”‚ â”‚ Verificationâ”‚â”‚
â”‚              â”‚    â”‚  â”‚ Cache  â”‚ â”‚ Validatorâ”‚ â”‚ Screen      â”‚â”‚
â”‚              â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                          â”‚           â”‚               â”‚        â”‚
â”‚                          â–¼           â–¼               â–¼        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                    â”‚         Database                     â”‚  â”‚
â”‚                    â”‚  â€¢ food_cache (30-day TTL)          â”‚  â”‚
â”‚                    â”‚  â€¢ meal_logs (with idempotency)     â”‚  â”‚
â”‚                    â”‚  â€¢ meal_items (exact USDA macros)   â”‚  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Macro Validator Logic                            â”‚
â”‚                                                               â”‚
â”‚  Input Macros     â†’    Validate    â†’    Result               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ kcal: 200  â”‚   â†’    â”‚ Tolerance  â”‚ â†’ â”‚ âœ“ Valid    â”‚      â”‚
â”‚  â”‚ protein: 20â”‚        â”‚ Â±5 kcal    â”‚   â”‚ 0 errors   â”‚      â”‚
â”‚  â”‚ carbs: 15  â”‚        â”‚ Â±0.5g      â”‚   â”‚ 0 warnings â”‚      â”‚
â”‚  â”‚ fat: 8     â”‚        â”‚            â”‚   â”‚            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â”‚  Expected: 202 kcal, 20.3g protein, 14.8g carbs, 8.2g fat    â”‚
â”‚  Result: âœ“ All within tolerance                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase 7: Deployment Lock Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    npm run build                              â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                 â”‚  Vite Plugin   â”‚                            â”‚
â”‚                 â”‚  buildStart()  â”‚                            â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚ Check for unlock:   â”‚                          â”‚
â”‚              â”‚ 1. DEPLOY_UNLOCKED  â”‚                          â”‚
â”‚              â”‚    file exists?     â”‚                          â”‚
â”‚              â”‚ 2. VITE_DEPLOYMENT_ â”‚                          â”‚
â”‚              â”‚    UNLOCKED=true?   â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                         â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚ YES                            â”‚ NO                 â”‚
â”‚         â–¼                                â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ âœ“ Continue   â”‚                 â”‚ âœ— Throw Errorâ”‚           â”‚
â”‚  â”‚   Build      â”‚                 â”‚   Show Help  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Credits System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Chat Conversation                            â”‚
â”‚                                                               â”‚
â”‚  User Message  â†’  AI Response  â†’  Credits Deducted           â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Send msg   â”‚ â†’ â”‚ Generate   â”‚ â†’ â”‚ spend_     â”‚           â”‚
â”‚  â”‚            â”‚   â”‚ response   â”‚   â”‚ credits()  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                           â”‚                   â”‚
â”‚                                           â–¼                   â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                              â”‚ Database            â”‚          â”‚
â”‚                              â”‚ â€¢ token_wallets     â”‚          â”‚
â”‚                              â”‚   balance -= 0.02   â”‚          â”‚
â”‚                              â”‚ â€¢ token_transactionsâ”‚          â”‚
â”‚                              â”‚   log: -$0.02       â”‚          â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                               â”‚
â”‚  Insufficient Credits?  â†’ âš ï¸  Warning logged, chat continues â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Feature Toggles Admin UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Admin Dashboard                             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             Feature Toggles                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  TMWYA          [BETA â–¼]  [ğŸŸ¢ ENABLED]               â”‚  â”‚
â”‚  â”‚  ShopLens       [BETA â–¼]  [ğŸŸ¢ ENABLED]               â”‚  â”‚
â”‚  â”‚  VoiceChat      [BETA â–¼]  [ğŸŸ¢ ENABLED]               â”‚  â”‚
â”‚  â”‚  MacroSwarm     [BETA â–¼]  [ğŸŸ¢ ENABLED]               â”‚  â”‚
â”‚  â”‚  PersonaSwarm   [BETA â–¼]  [ğŸŸ¢ ENABLED]               â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  Stage Options:                                        â”‚  â”‚
â”‚  â”‚  â€¢ ADMIN ONLY - Only admins can access                â”‚  â”‚
â”‚  â”‚  â€¢ BETA - Beta users + admins                         â”‚  â”‚
â”‚  â”‚  â€¢ PUBLIC - Everyone                                  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                   â”‚
â”‚                           â–¼                                   â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                  â”‚  role_access    â”‚                          â”‚
â”‚                  â”‚  table updates  â”‚                          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Role-Based Access

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                User Attempts Feature Access                   â”‚
â”‚                                                               â”‚
â”‚  User: john@example.com                                       â”‚
â”‚  Feature: TMWYA                                               â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ hasRoleAccess()â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚          â”‚                                                    â”‚
â”‚          â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ RPC: allowed_     â”‚                                        â”‚
â”‚  â”‚      roles()      â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                   â”‚
â”‚           â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Check User Profile:                    â”‚                  â”‚
â”‚  â”‚ â€¢ role = 'beta'                        â”‚                  â”‚
â”‚  â”‚ â€¢ beta_user = true                     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                    â”‚                                          â”‚
â”‚                    â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Query role_access:                     â”‚                  â”‚
â”‚  â”‚ SELECT * WHERE enabled = true          â”‚                  â”‚
â”‚  â”‚   AND (stage = 'public'                â”‚                  â”‚
â”‚  â”‚        OR (stage = 'beta' AND          â”‚                  â”‚
â”‚  â”‚            user.beta_user = true)      â”‚                  â”‚
â”‚  â”‚        OR (stage = 'admin' AND         â”‚                  â”‚
â”‚  â”‚            user.role = 'admin'))       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                    â”‚                                          â”‚
â”‚                    â–¼                                          â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚          â”‚ Returns:         â”‚                                 â”‚
â”‚          â”‚ â€¢ TMWYA          â”‚                                 â”‚
â”‚          â”‚ â€¢ ShopLens       â”‚                                 â”‚
â”‚          â”‚ â€¢ VoiceChat      â”‚                                 â”‚
â”‚          â”‚ â€¢ MacroSwarm     â”‚                                 â”‚
â”‚          â”‚ â€¢ PersonaSwarm   â”‚                                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                   â”‚                                           â”‚
â”‚                   â–¼                                           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚          â”‚ âœ“ Access Granted â”‚                                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure Created

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ FeatureToggles.tsx       [NEW: Admin toggle UI]
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ InboxBell.tsx            [NEW: Notification bell]
â”‚   â”‚   â””â”€â”€ InboxModal.tsx           [NEW: Announcements modal]
â”‚   â””â”€â”€ profile/
â”‚       â””â”€â”€ CreditsWallet.tsx        [NEW: Credits display]
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ announcements.ts             [NEW: Announcement API]
â”‚   â”œâ”€â”€ chatHistory.ts               [NEW: Chat persistence]
â”‚   â”œâ”€â”€ credits.ts                   [NEW: Credits API]
â”‚   â”œâ”€â”€ deploymentLock.ts            [NEW: Lock utilities]
â”‚   â”œâ”€â”€ foodCache.ts                 [NEW: Food cache API]
â”‚   â”œâ”€â”€ roleAccess.ts                [NEW: Role API]
â”‚   â””â”€â”€ macro/
â”‚       â”œâ”€â”€ formatter.ts             [MODIFIED: Added USDAMacros]
â”‚       â”œâ”€â”€ validator.ts             [NEW: Validation logic]
â”‚       â””â”€â”€ __tests__/
â”‚           â””â”€â”€ validator.test.ts    [NEW: Unit tests]
â”‚
â”œâ”€â”€ vite.config.ts                   [MODIFIED: Deploy lock plugin]
â”œâ”€â”€ .gitignore                       [MODIFIED: Added DEPLOY_UNLOCKED]
â”œâ”€â”€ DEPLOY_UNLOCKED                  [NEW: Unlock file]
â”‚
â””â”€â”€ Documentation/
    â”œâ”€â”€ PHASE_3_COMPLETE.md          [NEW: Phase 3 summary]
    â”œâ”€â”€ PHASE_5_7_COMPLETE.md        [NEW: Phase 5 & 7 summary]
    â”œâ”€â”€ FINAL_REPORT.md              [NEW: Complete report]
    â””â”€â”€ IMPLEMENTATION_DIAGRAM.md    [NEW: This file]
```

## Database Schema (New Tables)

```sql
-- Role-based feature access
CREATE TABLE role_access (
  role_name text PRIMARY KEY,
  stage text CHECK (stage IN ('admin', 'beta', 'public')),
  enabled boolean DEFAULT true,
  updated_at timestamptz DEFAULT now()
);

-- User credit wallets
CREATE TABLE token_wallets (
  user_id uuid PRIMARY KEY,
  balance_usd numeric(10,2) DEFAULT 0.00,
  plan text DEFAULT 'free',
  updated_at timestamptz DEFAULT now()
);

-- Credit transaction log
CREATE TABLE token_transactions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id),
  delta_usd numeric(10,2),
  reason text,
  created_at timestamptz DEFAULT now()
);

-- Admin announcements
CREATE TABLE announcements (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text,
  body text,
  audience text CHECK (audience IN ('beta', 'all')),
  created_at timestamptz DEFAULT now()
);

-- User read tracking
CREATE TABLE announcement_reads (
  user_id uuid,
  announcement_id uuid,
  read_at timestamptz DEFAULT now(),
  PRIMARY KEY (user_id, announcement_id)
);
```

## Key Integration Points

### 1. AppBar â†’ InboxBell â†’ Database
```typescript
// AppBar shows bell with unread count
<InboxBell />

// Bell fetches count every 60s
const count = await getUnreadCount(userId);

// Modal shows announcements
const announcements = await getAnnouncements(userId);
```

### 2. ChatPat â†’ Credits â†’ Database
```typescript
// After AI response
await spendCredits(PRICING.AMA_TURN, 'Chat turn');

// Updates wallet & logs transaction
UPDATE token_wallets SET balance_usd = balance_usd - 0.02;
INSERT INTO token_transactions VALUES (-0.02, 'Chat turn');
```

### 3. TMWYA â†’ Cache â†’ Validator â†’ Database
```typescript
// Check cache first
const cached = await getFoodFromCache({ name, brand });

// Validate macros
const validation = validateMacros(actual, expected);

// Save meal if valid
if (validation.valid) {
  await saveMeal(normalizedMeal);
}
```

### 4. Admin â†’ FeatureToggles â†’ Database
```typescript
// Toggle feature
await updateRoleAccess('TMWYA', 'public', true);

// Check access
const allowed = await getAllowedRoles(userId);
// Returns: ['TMWYA', 'ShopLens', ...]
```

## Summary

- **13 new files** created
- **5 existing files** modified
- **5 database tables** added
- **3 RPC functions** implemented
- **1 view** created
- **Build time**: ~8 seconds
- **Bundle size**: 278 KB (gzipped)
- **Test coverage**: Validator tests passing
- **Deployment**: Ready with manual lock
